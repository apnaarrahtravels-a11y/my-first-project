<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Apna Arrah Travels</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 1300px;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .options {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .option-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .option-btn.login {
            background: #1e3c72;
            color: white;
        }
        
        .option-btn.register {
            background: #f0f0f0;
            color: #333;
        }
        
        .option-btn.active {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(30, 60, 114, 0.4);
        }
        
        .form {
            display: none;
        }
        
        .form.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #1e3c72;
        }
        
        .submit-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
        }
        
        .message {
            margin-top: 20px;
            padding: 12px;
            border-radius: 10px;
            display: none;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }
        
        .dashboard {
            display: none;
        }
        
        .dashboard.active {
            display: block;
        }
        
        .user-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .user-info h3 {
            color: #333;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .menu-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .menu-item:hover {
            border-color: #1e3c72;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(30, 60, 114, 0.2);
        }
        
        .menu-item i {
            font-size: 32px;
            color: #1e3c72;
            margin-bottom: 10px;
            display: block;
        }
        
        .menu-item span {
            font-weight: 600;
            color: #555;
        }
        
        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .section h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .booking-form {
            background: white;
            padding: 20px;
            border-radius: 10px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        /* Filter Section Styles */
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .filter-group {
            flex: 1;
            min-width: 150px;
        }
        
        .filter-btn {
            background: #1e3c72;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            min-width: 100px;
        }
        
        .filter-btn:hover {
            background: #2a5298;
        }
        
        .filter-btn.reset {
            background: #6c757d;
        }
        
        .filter-btn.reset:hover {
            background: #5a6268;
        }
        
        /* Table Styles */
        .table-container {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
            border-radius: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
        }
        
        th {
            background: #1e3c72;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        .action-btn {
            background: #1e3c72;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin: 2px;
            font-size: 12px;
        }
        
        .action-btn:hover {
            background: #2a5298;
        }
        
        .action-btn.cancel {
            background: #dc3545;
        }
        
        .action-btn.cancel:hover {
            background: #c82333;
        }
        
        .month-trips {
            margin-bottom: 30px;
        }
        
        .month-title {
            background: #1e3c72;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .pending-amount {
            color: #dc3545;
            font-weight: bold;
        }
        
        .received-amount {
            color: #28a745;
            font-weight: bold;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: inline-block;
            width: 100%;
        }
        
        .summary-card.admin {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }
        
        .date-group {
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .date-header {
            background: #e9ecef;
            padding: 12px 15px;
            font-weight: bold;
            color: #495057;
            border-bottom: 2px solid #1e3c72;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-size: 16px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #1e3c72;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container" id="container">
        <div class="header">
            <h1>üöå Apna Arrah Travels</h1>
            <p>Your Journey, Our Responsibility</p>
        </div>
        
        <div class="content">
            <!-- Login/Register Section -->
            <div id="authSection">
                <div class="options">
                    <button class="option-btn login active" onclick="showForm('login')">Login</button>
                    <button class="option-btn register" onclick="showForm('register')">Register</button>
                </div>
                
                <!-- Login Form -->
                <div id="loginForm" class="form active">
                    <div class="form-group">
                        <label>User ID</label>
                        <input type="text" id="loginUserId" placeholder="Enter your user ID" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password">
                    </div>
                    <button class="submit-btn" onclick="handleLogin()">Login</button>
                </div>
                
                <!-- Register Form -->
                <div id="registerForm" class="form">
                    <div class="form-group">
                        <label>Choose User ID</label>
                        <input type="text" id="regUserId" placeholder="Choose a user ID">
                    </div>
                    <div class="form-group">
                        <label>Choose Password</label>
                        <input type="password" id="regPassword" placeholder="Choose a password">
                    </div>
                    <div class="form-group">
                        <label>Your Full Name</label>
                        <input type="text" id="regUsername" placeholder="Enter your full name">
                    </div>
                    <button class="submit-btn" onclick="handleRegister()">Register</button>
                </div>
            </div>
            
            <!-- Dashboard Section -->
            <div id="dashboard" class="dashboard">
                <div class="user-info">
                    <div>
                        <h3 id="welcomeMessage">Welcome, User!</h3>
                        <p id="userRole">Role: user</p>
                    </div>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
                
                <!-- Menu Grid -->
                <div class="menu-grid" id="menuGrid"></div>
                
                <!-- Trip Section -->
                <div id="tripSection" class="section">
                    <h2>üöå Month Wise Trips</h2>
                    <div id="tripList" class="table-container"></div>
                </div>
                
                <!-- New Booking Form Section -->
                <div id="bookingFormSection" class="section">
                    <h2>üìÖ New Booking</h2>
                    <div class="booking-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Booking Date * (DD/MM/YYYY)</label>
                                <input type="text" id="bookingDate" placeholder="DD/MM/YYYY" required 
                                       pattern="\d{2}/\d{2}/\d{4}" title="Please enter date in DD/MM/YYYY format">
                            </div>
                            <div class="form-group">
                                <label>Customer Name *</label>
                                <input type="text" id="customerName" placeholder="Enter customer name" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Phone Number *</label>
                                <input type="tel" id="phoneNumber" placeholder="Enter phone number" required>
                            </div>
                            <div class="form-group">
                                <label>Vehicle Required *</label>
                                <select id="vehicleType" required>
                                    <option value="">Select Vehicle</option>
                                    <option value="4 Seater">4 Seater</option>
                                    <option value="7 Seater">7 Seater</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Pickup Location *</label>
                                <input type="text" id="pickupLocation" placeholder="Enter pickup location" required>
                            </div>
                            <div class="form-group">
                                <label>Drop Location *</label>
                                <input type="text" id="dropLocation" placeholder="Enter drop location" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Pickup Time *</label>
                                <input type="time" id="pickupTime" required>
                            </div>
                            <div class="form-group">
                                <label>Total Amount (‚Çπ) *</label>
                                <input type="number" id="totalAmount" placeholder="Enter total amount" min="0" step="1" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Received Amount (‚Çπ) *</label>
                                <input type="number" id="receivedAmount" placeholder="Enter received amount" min="0" step="1" value="0" required>
                            </div>
                            <div class="form-group">
                                <label>Pending Amount (‚Çπ)</label>
                                <input type="number" id="pendingAmount" placeholder="Auto calculated" readonly>
                            </div>
                        </div>
                        
                        <button class="submit-btn" onclick="saveBooking()">üíæ Save Booking</button>
                    </div>
                </div>
                
                <!-- My Bookings Section (For Normal Users) -->
                <div id="myBookingsSection" class="section">
                    <h2>üìã My Bookings</h2>
                    
                    <div class="filter-section">
                        <div class="filter-group">
                            <label>Select Month</label>
                            <select id="userMonthFilter">
                                <option value="All">All Months</option>
                                <option value="January">January</option>
                                <option value="February">February</option>
                                <option value="March">March</option>
                                <option value="April">April</option>
                                <option value="May">May</option>
                                <option value="June">June</option>
                                <option value="July">July</option>
                                <option value="August">August</option>
                                <option value="September">September</option>
                                <option value="October">October</option>
                                <option value="November">November</option>
                                <option value="December">December</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Select Year</label>
                            <select id="userYearFilter">
                                <option value="All">All Years</option>
                            </select>
                        </div>
                        
                        <button class="filter-btn" onclick="loadUserBookings()">üîç Show My Bookings</button>
                        <button class="filter-btn reset" onclick="resetUserFilters()">üîÑ Reset</button>
                    </div>
                    
                    <div id="userBookingsSummary" class="summary-card" style="display: none;"></div>
                    <div id="userBookingsList" class="table-container"></div>
                </div>
                
                <!-- Admin All Bookings Section -->
                <div id="adminAllBookingsSection" class="section">
                    <h2>üëë All Users Bookings</h2>
                    
                    <div class="filter-section">
                        <div class="filter-group">
                            <label>Select User</label>
                            <select id="adminUserFilter">
                                <option value="All">All Users</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Select Month</label>
                            <select id="adminMonthFilter">
                                <option value="All">All Months</option>
                                <option value="January">January</option>
                                <option value="February">February</option>
                                <option value="March">March</option>
                                <option value="April">April</option>
                                <option value="May">May</option>
                                <option value="June">June</option>
                                <option value="July">July</option>
                                <option value="August">August</option>
                                <option value="September">September</option>
                                <option value="October">October</option>
                                <option value="November">November</option>
                                <option value="December">December</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Select Year</label>
                            <select id="adminYearFilter">
                                <option value="All">All Years</option>
                            </select>
                        </div>
                        
                        <button class="filter-btn" onclick="loadAdminAllBookings()">üîç Show Bookings</button>
                        <button class="filter-btn reset" onclick="resetAdminAllFilters()">üîÑ Reset</button>
                    </div>
                    
                    <div id="adminAllBookingsSummary" class="summary-card admin" style="display: none;"></div>
                    <div id="adminAllBookingsList" class="table-container"></div>
                </div>
                
                <!-- Admin Cancel Booking Section -->
                <div id="adminCancelSection" class="section">
                    <h2>‚ùå Cancel Bookings (Admin)</h2>
                    
                    <div class="filter-section">
                        <div class="filter-group">
                            <label>Select User</label>
                            <select id="cancelUserFilter">
                                <option value="All">All Users</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Select Month</label>
                            <select id="cancelMonthFilter">
                                <option value="All">All Months</option>
                                <option value="January">January</option>
                                <option value="February">February</option>
                                <option value="March">March</option>
                                <option value="April">April</option>
                                <option value="May">May</option>
                                <option value="June">June</option>
                                <option value="July">July</option>
                                <option value="August">August</option>
                                <option value="September">September</option>
                                <option value="October">October</option>
                                <option value="November">November</option>
                                <option value="December">December</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Select Year</label>
                            <select id="cancelYearFilter">
                                <option value="All">All Years</option>
                            </select>
                        </div>
                        
                        <button class="filter-btn" onclick="loadCancelBookings()">üîç Show Bookings to Cancel</button>
                        <button class="filter-btn reset" onclick="resetCancelFilters()">üîÑ Reset</button>
                    </div>
                    
                    <div id="cancelBookingsSummary" class="summary-card admin" style="display: none;"></div>
                    <div id="cancelBookingsList" class="table-container"></div>
                </div>
                
                <!-- New User Section (Admin Only) -->
                <div id="newUserSection" class="section">
                    <h2>üë§ Create New User (Admin Only)</h2>
                    <div class="form-group">
                        <label>Your Admin Password</label>
                        <input type="password" id="adminPassword" placeholder="Enter your admin password">
                    </div>
                    <div class="form-group">
                        <label>New User ID</label>
                        <input type="text" id="newUserId" placeholder="Enter user ID">
                    </div>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="newUserPassword" placeholder="Enter password">
                    </div>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="newUsername" placeholder="Enter full name">
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <select id="newUserRole">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <button class="submit-btn" onclick="adminCreateUser()">Create User</button>
                </div>
            </div>
            
            <!-- Message Display -->
            <div id="message" class="message"></div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let allUsers = [];
        
        function showForm(type) {
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (type === 'login') {
                document.querySelector('.option-btn.login').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
                document.getElementById('registerForm').classList.remove('active');
            } else {
                document.querySelector('.option-btn.register').classList.add('active');
                document.getElementById('registerForm').classList.add('active');
                document.getElementById('loginForm').classList.remove('active');
            }
            
            hideMessage();
        }
        
        function showMessage(text, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = text;
            msgDiv.className = 'message ' + type;
        }
        
        function hideMessage() {
            document.getElementById('message').className = 'message';
        }
        
        function handleLogin() {
            const userId = document.getElementById('loginUserId').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!userId || !password) {
                showMessage('Please fill all fields', 'error');
                return;
            }
            
            showMessage('Verifying...', 'info');
            
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        currentUser = {
                            userId: userId,
                            role: response.role,
                            username: response.username
                        };
                        showDashboard();
                        showMessage('Login successful!', 'success');
                    } else {
                        showMessage(response.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('Error: ' + error, 'error');
                })
                .verifyLogin(userId, password);
        }
        
        function handleRegister() {
            const userId = document.getElementById('regUserId').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            const username = document.getElementById('regUsername').value.trim();
            
            if (!userId || !password || !username) {
                showMessage('Please fill all fields', 'error');
                return;
            }
            
            showMessage('Registering...', 'info');
            
            google.script.run
                .withSuccessHandler(function(response) {
                    showMessage(response.message, response.success ? 'success' : 'error');
                    if (response.success) {
                        setTimeout(() => {
                            showForm('login');
                        }, 2000);
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('Error: ' + error, 'error');
                })
                .registerUser(userId, password, username);
        }
        
        function showDashboard() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('welcomeMessage').textContent = `Welcome, ${currentUser.username}!`;
            document.getElementById('userRole').textContent = `Role: ${currentUser.role}`;
            
            const menuGrid = document.getElementById('menuGrid');
            menuGrid.innerHTML = '';
            
            const menuItems = [
                { name: 'Trips', icon: 'üöå', section: 'trip', action: () => showSection('trip') },
                { name: 'New Booking', icon: 'üìÖ', section: 'bookingForm', action: () => showSection('bookingForm') }
            ];
            
            if (currentUser.role && currentUser.role.toLowerCase() === 'admin') {
                menuItems.push(
                    { name: 'All Bookings', icon: 'üìã', section: 'adminAllBookings', action: () => showSection('adminAllBookings') },
                    { name: 'Cancel Booking', icon: '‚ùå', section: 'adminCancel', action: () => showSection('adminCancel') },
                    { name: 'Create User', icon: 'üë§', section: 'newuser', action: () => showSection('newuser') }
                );
            } else {
                menuItems.push(
                    { name: 'My Bookings', icon: 'üìã', section: 'myBookings', action: () => showSection('myBookings') }
                );
            }
            
            menuItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'menu-item';
                div.onclick = item.action;
                div.innerHTML = `<i>${item.icon}</i><span>${item.name}</span>`;
                menuGrid.appendChild(div);
            });
            
            loadTrips();
            loadAvailableYears();
            loadAllNormalUsers();
            
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            document.getElementById('bookingDate').value = `${day}/${month}/${year}`;
            
            document.getElementById('totalAmount').addEventListener('input', calculatePending);
            document.getElementById('receivedAmount').addEventListener('input', calculatePending);
        }
        
        function calculatePending() {
            const total = parseFloat(document.getElementById('totalAmount').value) || 0;
            const received = parseFloat(document.getElementById('receivedAmount').value) || 0;
            const pending = total - received;
            document.getElementById('pendingAmount').value = pending >= 0 ? pending : 0;
        }
        
        function loadAvailableYears() {
            google.script.run
                .withSuccessHandler(function(years) {
                    // User filters
                    const userYearFilter = document.getElementById('userYearFilter');
                    userYearFilter.innerHTML = '<option value="All">All Years</option>';
                    
                    // Admin filters
                    const adminYearFilter = document.getElementById('adminYearFilter');
                    adminYearFilter.innerHTML = '<option value="All">All Years</option>';
                    
                    // Cancel filters
                    const cancelYearFilter = document.getElementById('cancelYearFilter');
                    cancelYearFilter.innerHTML = '<option value="All">All Years</option>';
                    
                    years.forEach(year => {
                        userYearFilter.appendChild(new Option(year, year));
                        adminYearFilter.appendChild(new Option(year, year));
                        cancelYearFilter.appendChild(new Option(year, year));
                    });
                    
                    const currentYear = new Date().getFullYear().toString();
                    if (years.includes(currentYear)) {
                        userYearFilter.value = currentYear;
                        adminYearFilter.value = currentYear;
                        cancelYearFilter.value = currentYear;
                    }
                })
                .getAvailableYears();
        }
        
        function loadAllNormalUsers() {
            google.script.run
                .withSuccessHandler(function(users) {
                    allUsers = users;
                    
                    // Update all user dropdowns
                    const adminUserFilter = document.getElementById('adminUserFilter');
                    const cancelUserFilter = document.getElementById('cancelUserFilter');
                    
                    adminUserFilter.innerHTML = '<option value="All">All Users</option>';
                    cancelUserFilter.innerHTML = '<option value="All">All Users</option>';
                    
                    users.forEach(user => {
                        const option1 = new Option(user.userName + ' (' + user.userId + ')', user.userId);
                        const option2 = new Option(user.userName + ' (' + user.userId + ')', user.userId);
                        
                        adminUserFilter.appendChild(option1);
                        cancelUserFilter.appendChild(option2);
                    });
                })
                .getAllNormalUsers();
        }
        
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            if (section === 'trip') {
                document.getElementById('tripSection').classList.add('active');
                loadTrips();
            }
            else if (section === 'bookingForm') {
                document.getElementById('bookingFormSection').classList.add('active');
                resetBookingForm();
            }
            else if (section === 'myBookings') {
                document.getElementById('myBookingsSection').classList.add('active');
                const months = ["January", "February", "March", "April", "May", "June",
                              "July", "August", "September", "October", "November", "December"];
                const currentMonth = months[new Date().getMonth()];
                document.getElementById('userMonthFilter').value = currentMonth;
                loadUserBookings();
            }
            else if (section === 'adminAllBookings') {
                document.getElementById('adminAllBookingsSection').classList.add('active');
                const months = ["January", "February", "March", "April", "May", "June",
                              "July", "August", "September", "October", "November", "December"];
                const currentMonth = months[new Date().getMonth()];
                document.getElementById('adminMonthFilter').value = currentMonth;
                loadAdminAllBookings();
            }
            else if (section === 'adminCancel') {
                document.getElementById('adminCancelSection').classList.add('active');
                const months = ["January", "February", "March", "April", "May", "June",
                              "July", "August", "September", "October", "November", "December"];
                const currentMonth = months[new Date().getMonth()];
                document.getElementById('cancelMonthFilter').value = currentMonth;
                loadCancelBookings();
            }
            else if (section === 'newuser') {
                document.getElementById('newUserSection').classList.add('active');
            }
        }
        
        function resetBookingForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('phoneNumber').value = '';
            document.getElementById('vehicleType').value = '';
            document.getElementById('pickupLocation').value = '';
            document.getElementById('dropLocation').value = '';
            document.getElementById('pickupTime').value = '';
            document.getElementById('totalAmount').value = '';
            document.getElementById('receivedAmount').value = '0';
            document.getElementById('pendingAmount').value = '0';
            
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            document.getElementById('bookingDate').value = `${day}/${month}/${year}`;
        }
        
        // ========== USER BOOKINGS ==========
        function loadUserBookings() {
            const month = document.getElementById('userMonthFilter').value;
            const year = document.getElementById('userYearFilter').value;
            
            document.getElementById('userBookingsList').innerHTML = '<div class="loading">Loading bookings...</div>';
            
            google.script.run
                .withSuccessHandler(function(bookings) {
                    displayUserBookings(bookings, month, year);
                })
                .withFailureHandler(function(error) {
                    showMessage('Error loading bookings: ' + error, 'error');
                })
                .getUserBookingsByMonthYear(currentUser.userId, month, year);
        }
        
        function displayUserBookings(bookings, selectedMonth, selectedYear) {
            const bookingsList = document.getElementById('userBookingsList');
            const summaryDiv = document.getElementById('userBookingsSummary');
            
            if (bookings && bookings.length > 0) {
                const dateWiseBookings = {};
                let totalAmount = 0, totalReceived = 0, totalPending = 0;
                
                bookings.forEach(booking => {
                    const date = booking.bookingDate;
                    if (!dateWiseBookings[date]) {
                        dateWiseBookings[date] = [];
                    }
                    dateWiseBookings[date].push(booking);
                    
                    totalAmount += booking.totalAmount || 0;
                    totalReceived += booking.receivedAmount || 0;
                    totalPending += booking.pendingAmount || 0;
                });
                
                let filterText = '';
                if (selectedMonth !== 'All' && selectedYear !== 'All') {
                    filterText = ` for ${selectedMonth} ${selectedYear}`;
                } else if (selectedMonth !== 'All') {
                    filterText = ` for ${selectedMonth}`;
                } else if (selectedYear !== 'All') {
                    filterText = ` for ${selectedYear}`;
                }
                
                summaryDiv.style.display = 'inline-block';
                summaryDiv.innerHTML = `
                    <strong>üìä Total Bookings${filterText}: ${bookings.length}</strong><br>
                    Total: ‚Çπ${totalAmount.toFixed(2)} | 
                    Received: ‚Çπ${totalReceived.toFixed(2)} | 
                    Pending: ‚Çπ${totalPending.toFixed(2)}
                `;
                
                const sortedDates = Object.keys(dateWiseBookings).sort((a, b) => {
                    const [dayA, monthA, yearA] = a.split('/').map(Number);
                    const [dayB, monthB, yearB] = b.split('/').map(Number);
                    return new Date(yearB, monthB - 1, dayB) - new Date(yearA, monthA - 1, dayA);
                });
                
                let html = '';
                sortedDates.forEach(date => {
                    html += `<div class="date-group">`;
                    html += `<div class="date-header">üìÖ ${date}</div>`;
                    html += `<table>`;
                    html += `<tr>
                        <th>Booking ID</th>
                        <th>Customer</th>
                        <th>Phone</th>
                        <th>Vehicle</th>
                        <th>Pickup</th>
                        <th>Drop</th>
                        <th>Time</th>
                        <th>Total</th>
                        <th>Received</th>
                        <th>Pending</th>
                        <th>Status</th>
                    </tr>`;
                    
                    dateWiseBookings[date].forEach(booking => {
                        const pendingClass = booking.pendingAmount > 0 ? 'pending-amount' : '';
                        html += `<tr>
                            <td>${booking.bookingId}</td>
                            <td>${booking.customerName}</td>
                            <td>${booking.phoneNumber}</td>
                            <td>${booking.vehicleType}</td>
                            <td>${booking.pickupLocation}</td>
                            <td>${booking.dropLocation}</td>
                            <td>${booking.pickupTime}</td>
                            <td>‚Çπ${booking.totalAmount}</td>
                            <td class="received-amount">‚Çπ${booking.receivedAmount}</td>
                            <td class="${pendingClass}">‚Çπ${booking.pendingAmount}</td>
                            <td>${booking.status}</td>
                        </tr>`;
                    });
                    
                    html += `</table>`;
                    html += `</div>`;
                });
                
                bookingsList.innerHTML = html;
            } else {
                summaryDiv.style.display = 'none';
                bookingsList.innerHTML = '<div class="no-data">üì≠ No bookings found for selected period</div>';
            }
        }
        
        function resetUserFilters() {
            document.getElementById('userMonthFilter').value = 'All';
            document.getElementById('userYearFilter').value = 'All';
            loadUserBookings();
        }
        
        // ========== ADMIN ALL BOOKINGS ==========
        function loadAdminAllBookings() {
            const month = document.getElementById('adminMonthFilter').value;
            const year = document.getElementById('adminYearFilter').value;
            const selectedUser = document.getElementById('adminUserFilter').value;
            
            document.getElementById('adminAllBookingsList').innerHTML = '<div class="loading">Loading bookings...</div>';
            
            google.script.run
                .withSuccessHandler(function(bookings) {
                    displayAdminAllBookings(bookings, month, year, selectedUser);
                })
                .withFailureHandler(function(error) {
                    showMessage('Error loading bookings: ' + error, 'error');
                })
                .getAllBookingsForAdmin(month, year, selectedUser);
        }
        
        function displayAdminAllBookings(bookings, selectedMonth, selectedYear, selectedUser) {
            const bookingsList = document.getElementById('adminAllBookingsList');
            const summaryDiv = document.getElementById('adminAllBookingsSummary');
            
            if (bookings && bookings.length > 0) {
                const dateWiseBookings = {};
                let totalAmount = 0, totalReceived = 0, totalPending = 0;
                
                bookings.forEach(booking => {
                    const date = booking.bookingDate;
                    if (!dateWiseBookings[date]) {
                        dateWiseBookings[date] = [];
                    }
                    dateWiseBookings[date].push(booking);
                    
                    totalAmount += booking.totalAmount || 0;
                    totalReceived += booking.receivedAmount || 0;
                    totalPending += booking.pendingAmount || 0;
                });
                
                let filterText = '';
                if (selectedUser !== 'All') {
                    const user = allUsers.find(u => u.userId === selectedUser);
                    filterText += ` for User: ${user ? user.userName : selectedUser}`;
                }
                if (selectedMonth !== 'All') {
                    filterText += `, Month: ${selectedMonth}`;
                }
                if (selectedYear !== 'All') {
                    filterText += `, Year: ${selectedYear}`;
                }
                
                summaryDiv.style.display = 'inline-block';
                summaryDiv.innerHTML = `
                    <strong>üìä Total Bookings${filterText}: ${bookings.length}</strong><br>
                    Total: ‚Çπ${totalAmount.toFixed(2)} | 
                    Received: ‚Çπ${totalReceived.toFixed(2)} | 
                    Pending: ‚Çπ${totalPending.toFixed(2)}
                `;
                
                const sortedDates = Object.keys(dateWiseBookings).sort((a, b) => {
                    const [dayA, monthA, yearA] = a.split('/').map(Number);
                    const [dayB, monthB, yearB] = b.split('/').map(Number);
                    return new Date(yearB, monthB - 1, dayB) - new Date(yearA, monthA - 1, dayA);
                });
                
                let html = '';
                sortedDates.forEach(date => {
                    html += `<div class="date-group">`;
                    html += `<div class="date-header">üìÖ ${date}</div>`;
                    html += `<table>`;
                    html += `<tr>
                        <th>Booking ID</th>
                        <th>User</th>
                        <th>Customer</th>
                        <th>Phone</th>
                        <th>Vehicle</th>
                        <th>Pickup</th>
                        <th>Drop</th>
                        <th>Time</th>
                        <th>Total</th>
                        <th>Received</th>
                        <th>Pending</th>
                        <th>Status</th>
                    </tr>`;
                    
                    dateWiseBookings[date].forEach(booking => {
                        const pendingClass = booking.pendingAmount > 0 ? 'pending-amount' : '';
                        html += `<tr>
                            <td>${booking.bookingId}</td>
                            <td>${booking.createdBy}</td>
                            <td>${booking.customerName}</td>
                            <td>${booking.phoneNumber}</td>
                            <td>${booking.vehicleType}</td>
                            <td>${booking.pickupLocation}</td>
                            <td>${booking.dropLocation}</td>
                            <td>${booking.pickupTime}</td>
                            <td>‚Çπ${booking.totalAmount}</td>
                            <td class="received-amount">‚Çπ${booking.receivedAmount}</td>
                            <td class="${pendingClass}">‚Çπ${booking.pendingAmount}</td>
                            <td>${booking.status}</td>
                        </tr>`;
                    });
                    
                    html += `</table>`;
                    html += `</div>`;
                });
                
                bookingsList.innerHTML = html;
            } else {
                summaryDiv.style.display = 'none';
                bookingsList.innerHTML = '<div class="no-data">üì≠ No bookings found for selected filters</div>';
            }
        }
        
        function resetAdminAllFilters() {
            document.getElementById('adminUserFilter').value = 'All';
            document.getElementById('adminMonthFilter').value = 'All';
            document.getElementById('adminYearFilter').value = 'All';
            loadAdminAllBookings();
        }
        
        // ========== ADMIN CANCEL BOOKINGS ==========
        function loadCancelBookings() {
            const month = document.getElementById('cancelMonthFilter').value;
            const year = document.getElementById('cancelYearFilter').value;
            const selectedUser = document.getElementById('cancelUserFilter').value;
            
            document.getElementById('cancelBookingsList').innerHTML = '<div class="loading">Loading bookings...</div>';
            
            google.script.run
                .withSuccessHandler(function(bookings) {
                    displayCancelBookings(bookings, month, year, selectedUser);
                })
                .withFailureHandler(function(error) {
                    showMessage('Error loading bookings: ' + error, 'error');
                })
                .getAllBookingsForAdmin(month, year, selectedUser);
        }
        
        function displayCancelBookings(bookings, selectedMonth, selectedYear, selectedUser) {
            const bookingsList = document.getElementById('cancelBookingsList');
            const summaryDiv = document.getElementById('cancelBookingsSummary');
            
            if (bookings && bookings.length > 0) {
                const dateWiseBookings = {};
                let totalAmount = 0, totalReceived = 0, totalPending = 0;
                let activeBookings = 0;
                
                bookings.forEach(booking => {
                    const date = booking.bookingDate;
                    if (!dateWiseBookings[date]) {
                        dateWiseBookings[date] = [];
                    }
                    dateWiseBookings[date].push(booking);
                    
                    totalAmount += booking.totalAmount || 0;
                    totalReceived += booking.receivedAmount || 0;
                    totalPending += booking.pendingAmount || 0;
                    if (booking.status !== 'Cancelled') {
                        activeBookings++;
                    }
                });
                
                let filterText = '';
                if (selectedUser !== 'All') {
                    const user = allUsers.find(u => u.userId === selectedUser);
                    filterText += ` for User: ${user ? user.userName : selectedUser}`;
                }
                if (selectedMonth !== 'All') {
                    filterText += `, Month: ${selectedMonth}`;
                }
                if (selectedYear !== 'All') {
                    filterText += `, Year: ${selectedYear}`;
                }
                
                summaryDiv.style.display = 'inline-block';
                summaryDiv.innerHTML = `
                    <strong>üìä Active Bookings to Cancel${filterText}: ${activeBookings}</strong><br>
                    Total: ‚Çπ${totalAmount.toFixed(2)} | 
                    Received: ‚Çπ${totalReceived.toFixed(2)} | 
                    Pending: ‚Çπ${totalPending.toFixed(2)}
                `;
                
                const sortedDates = Object.keys(dateWiseBookings).sort((a, b) => {
                    const [dayA, monthA, yearA] = a.split('/').map(Number);
                    const [dayB, monthB, yearB] = b.split('/').map(Number);
                    return new Date(yearB, monthB - 1, dayB) - new Date(yearA, monthA - 1, dayA);
                });
                
                let html = '';
                sortedDates.forEach(date => {
                    html += `<div class="date-group">`;
                    html += `<div class="date-header">üìÖ ${date}</div>`;
                    html += `<table>`;
                    html += `<tr>
                        <th>Booking ID</th>
                        <th>User</th>
                        <th>Customer</th>
                        <th>Phone</th>
                        <th>Vehicle</th>
                        <th>Pickup</th>
                        <th>Drop</th>
                        <th>Time</th>
                        <th>Total</th>
                        <th>Received</th>
                        <th>Pending</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>`;
                    
                    dateWiseBookings[date].forEach(booking => {
                        const pendingClass = booking.pendingAmount > 0 ? 'pending-amount' : '';
                        html += `<tr>
                            <td>${booking.bookingId}</td>
                            <td>${booking.createdBy}</td>
                            <td>${booking.customerName}</td>
                            <td>${booking.phoneNumber}</td>
                            <td>${booking.vehicleType}</td>
                            <td>${booking.pickupLocation}</td>
                            <td>${booking.dropLocation}</td>
                            <td>${booking.pickupTime}</td>
                            <td>‚Çπ${booking.totalAmount}</td>
                            <td class="received-amount">‚Çπ${booking.receivedAmount}</td>
                            <td class="${pendingClass}">‚Çπ${booking.pendingAmount}</td>
                            <td>${booking.status}</td>
                            <td>
                                ${booking.status !== 'Cancelled' ? 
                                    `<button class="action-btn cancel" onclick="cancelAdminBooking('${booking.bookingId}')">Cancel</button>` : 
                                    'Cancelled'}
                            </td>
                        </tr>`;
                    });
                    
                    html += `</table>`;
                    html += `</div>`;
                });
                
                bookingsList.innerHTML = html;
            } else {
                summaryDiv.style.display = 'none';
                bookingsList.innerHTML = '<div class="no-data">üì≠ No bookings found for selected filters</div>';
            }
        }
        
        function resetCancelFilters() {
            document.getElementById('cancelUserFilter').value = 'All';
            document.getElementById('cancelMonthFilter').value = 'All';
            document.getElementById('cancelYearFilter').value = 'All';
            loadCancelBookings();
        }
        
        function cancelAdminBooking(bookingId) {
            if (confirm('Are you sure you want to cancel this booking?')) {
                google.script.run
                    .withSuccessHandler(function(response) {
                        showMessage(response.message, response.success ? 'success' : 'error');
                        if (response.success) {
                            // Reload both admin sections
                            if (document.getElementById('adminAllBookingsSection').classList.contains('active')) {
                                loadAdminAllBookings();
                            }
                            if (document.getElementById('adminCancelSection').classList.contains('active')) {
                                loadCancelBookings();
                            }
                        }
                    })
                    .cancelBooking(bookingId, currentUser.userId, true);
            }
        }
        
        // ========== TRIPS ==========
        function loadTrips() {
            google.script.run
                .withSuccessHandler(function(response) {
                    const tripList = document.getElementById('tripList');
                    
                    if (response.success && Object.keys(response.monthWiseTrips).length > 0) {
                        let html = '';
                        
                        response.months.forEach(month => {
                            if (response.monthWiseTrips[month] && response.monthWiseTrips[month].length > 0) {
                                html += `<div class="month-trips">`;
                                html += `<div class="month-title">üìÖ ${month}</div>`;
                                html += `<div class="table-container">`;
                                html += `<table>`;
                                html += `<tr><th>Trip Name</th><th>Date</th><th>Destination</th><th>Price</th><th>Status</th></tr>`;
                                
                                response.monthWiseTrips[month].forEach(trip => {
                                    html += `<tr>
                                        <td>${trip.tripName}</td>
                                        <td>${trip.date}</td>
                                        <td>${trip.destination}</td>
                                        <td>‚Çπ${trip.price}</td>
                                        <td>${trip.status}</td>
                                    </tr>`;
                                });
                                
                                html += `</table>`;
                                html += `</div>`;
                                html += `</div>`;
                            }
                        });
                        
                        tripList.innerHTML = html;
                    } else {
                        tripList.innerHTML = '<div class="no-data">üöå No trips available</div>';
                    }
                })
                .getAllTrips();
        }
        
        // ========== SAVE BOOKING ==========
        function saveBooking() {
            const datePattern = /^\d{2}\/\d{2}\/\d{4}$/;
            const bookingDate = document.getElementById('bookingDate').value.trim();
            
            if (!datePattern.test(bookingDate)) {
                showMessage('Please enter date in DD/MM/YYYY format', 'error');
                return;
            }
            
            const bookingData = {
                bookingDate: bookingDate,
                customerName: document.getElementById('customerName').value.trim(),
                phoneNumber: document.getElementById('phoneNumber').value.trim(),
                vehicleType: document.getElementById('vehicleType').value,
                pickupLocation: document.getElementById('pickupLocation').value.trim(),
                dropLocation: document.getElementById('dropLocation').value.trim(),
                pickupTime: document.getElementById('pickupTime').value,
                totalAmount: document.getElementById('totalAmount').value,
                receivedAmount: document.getElementById('receivedAmount').value || '0',
                createdBy: currentUser.userId
            };
            
            for (let key in bookingData) {
                if (key !== 'receivedAmount' && !bookingData[key]) {
                    showMessage('Please fill all required fields', 'error');
                    return;
                }
            }
            
            if (bookingData.phoneNumber.length < 10) {
                showMessage('Please enter valid phone number', 'error');
                return;
            }
            
            showMessage('Saving booking...', 'info');
            
            google.script.run
                .withSuccessHandler(function(response) {
                    showMessage(response.message, response.success ? 'success' : 'error');
                    if (response.success) {
                        resetBookingForm();
                        loadAvailableYears();
                        
                        setTimeout(() => {
                            if (confirm('Booking saved! Would you like to view the bookings?')) {
                                if (currentUser.role === 'admin') {
                                    showSection('adminAllBookings');
                                } else {
                                    showSection('myBookings');
                                }
                            }
                        }, 1000);
                    }
                })
                .saveBooking(bookingData);
        }
        
        // ========== ADMIN CREATE USER ==========
        function adminCreateUser() {
            const adminPassword = document.getElementById('adminPassword').value.trim();
            const newUserData = {
                userId: document.getElementById('newUserId').value.trim(),
                password: document.getElementById('newUserPassword').value.trim(),
                username: document.getElementById('newUsername').value.trim(),
                role: document.getElementById('newUserRole').value
            };
            
            if (!adminPassword || !newUserData.userId || !newUserData.password || !newUserData.username) {
                showMessage('Please fill all fields', 'error');
                return;
            }
            
            showMessage('Creating user...', 'info');
            
            google.script.run
                .withSuccessHandler(function(response) {
                    showMessage(response.message, response.success ? 'success' : 'error');
                    if (response.success) {
                        document.getElementById('adminPassword').value = '';
                        document.getElementById('newUserId').value = '';
                        document.getElementById('newUserPassword').value = '';
                        document.getElementById('newUsername').value = '';
                        loadAllNormalUsers();
                    }
                })
                .adminCreateUser(currentUser.userId, adminPassword, newUserData);
        }
        
        // ========== LOGOUT ==========
        function logout() {
            currentUser = null;
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
            showForm('login');
            hideMessage();
            
            document.getElementById('loginUserId').value = '';
            document.getElementById('loginPassword').value = '';
        }
    </script>
</body>
</html>